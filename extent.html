<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no">
    <title>Extent</title>
    <link rel="stylesheet" href="https://js.arcgis.com/3.24/dijit/themes/claro/claro.css">
    <link rel="stylesheet" href="https://js.arcgis.com/3.24/esri/css/esri.css">
    <style>
        html,
        body,
        #map {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
        }

        .toolbar {
            position: absolute;
            top: 0;
            width: 100%;
            height: 24px;
            background-color: #007ac2;
            color: #fff;
        }

        .content {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 24px;
        }

        .action {
            cursor: pointer;
            text-decoration: underline;
        }

        #anonymous {
            display: none;
            padding: 5px;
            text-align: center;
        }

        #personalized {
            display: none;
            padding: 5px;
            text-align: center;
        }

        #userId {
            font-weight: bold;
        }
    </style>

    <script>
        var dojoConfig = {
            parseOnLoad: true
        };
    </script>
    <script src="https://js.arcgis.com/3.24/"></script>
    <script>
        var map, graphicLayer, featureLayer;
        require([
            "esri/map",
            "esri/layers/FeatureLayer",
            "esri/geometry/Point",
            "esri/graphic",
            "esri/layers/GraphicsLayer",
            "esri/symbols/SimpleMarkerSymbol",
            "esri/symbols/SimpleFillSymbol",
            "esri/symbols/SimpleLineSymbol",
            "esri/SpatialReference",
            "esri/Color",
            "esri/InfoTemplate",
            "dojo/on",
            "dojo/_base/array",
            "esri/arcgis/Portal",
            "esri/arcgis/OAuthInfo",
            "esri/IdentityManager",
            "dojo/dom-style",
            "dojo/dom-attr",
            "dojo/dom",
            "esri/tasks/query",
            "esri/arcgis/utils",
            "esri/request",
            "esri/geometry/Extent",
            "esri/SpatialReference",
            "dojo/domReady!"
        ], function (
            Map,
            FeatureLayer,
            Point,
            Graphic,
            GraphicsLayer,
            SimpleMarkerSymbol,
            SimpleFillSymbol,
            SimpleLineSymbol,
            SpatialReference,
            Color,
            InfoTemplate,
            on,
            array,
            arcgisPortal,
            OAuthInfo,
            esriId,
            domStyle,
            domAttr,
            dom,
            Query,
            arcgisUtils,
            esriRequest
        ) {
                esri.config.defaults.io.corsEnabledServers.push("http://bankbeetle.esri.com");
                var info = new OAuthInfo({
                    appId: "r39INBsvcaokxCns",
                    popup: false,
                    portalUrl: "https://bankbeetle.esri.com/portal"
                });

                esriId.registerOAuthInfos([info]);
                esriId.checkSignInStatus(info.portalUrl + "/sharing").then(
                    function () {
                        new arcgisPortal.Portal(info.portalUrl).signIn().then(
                            function (portalUser) {
                                domAttr.set("userId", "innerHTML", portalUser.fullName);
                                domStyle.set("anonymous", "display", "none");
                                domStyle.set("personalized", "display", "block");
                                addLayers();
                            }
                        );
                    }
                ).otherwise(
                    function () {
                        domStyle.set("anonymous", "display", "block");
                        domStyle.set("personalized", "display", "none");
                    }
                );

                on(dom.byId("sign-in"), "click", function () {
                    console.log("sign-in");
                    esriId.getCredential(info.portalUrl + "/sharing");
                });

                on(dom.byId("sign-out"), "click", function () {
                    esriId.destroyCredentials();
                    window.location.reload();
                });

                map = new Map("map", {
                    basemap: "gray",
                    center: [-46.807, 32.553],
                    zoom: 4
                });

                function addLayers() {
                    featureLayer = new FeatureLayer("https://bankbeetle.esri.com/arcgis/rest/services/Hosted/USA_Boundaries_2015/FeatureServer/1");
                    //featureLayer.on('load', queryFeatures());
                    featureLayer.on('load', queryFeatures());
                }

                function getFillSymbol() {
                    var r = Math.floor(Math.random() * 250);
                    var g = Math.floor(Math.random() * 100);
                    var b = Math.floor(Math.random() * 100);
                    return new SimpleFillSymbol(SimpleFillSymbol.STYLE_SOLID,
                        new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID,
                            new Color([r, g, b]), 1), new Color([r, g, b, 0.25])
                    );
                }

                function requestSucceeded(res) {
                    // for (var i = 0; i < res.features.length; i++) {
                    //     console.log(res.features[i]);
                    // }

                    //var extent = new Extent(JSON.stringify(res.extent));
                    var extent = new esri.geometry.Extent({
                        "xmin": res.extent.xmin, "ymin": res.extent.ymin, "xmax": res.extent.xmax, "ymax": res.extent.ymax,
                        "spatialReference": { "wkid": 4326 }
                    });
                    var sfs = getFillSymbol();
                    var graphic = new Graphic(extent, sfs);
                    graphicLayer.add(graphic);
                }

                function requestFailed(evt) {
                    console.log("failed", evt);
                }

                function queryFeature(oid) {
                    var params = {
                        objectIds: oid,
                        returnExtentOnly: true,
                        f: "json"
                    };
                    var requestHandle = esriRequest({
                        url: featureLayer.url + '/query',
                        content: params,
                        handleAs: "json",
                    }, {
                            usePost: false
                        });

                    requestHandle.then(requestSucceeded, requestFailed);

                }

                function queryFeatures() {
                    graphicLayer = new GraphicsLayer();
                    map.addLayer(graphicLayer);
                    console.log("featureLayer", featureLayer);
                    var oids = [1, 2, 3];
                    for (var i = 0; i < oids.length; i++) {
                        queryFeature(oids[i]);
                    }
                    return;
                    var params = {
                        objectIds: "1,2,3",
                        outFields: ["*"],
                        returnGeometry: true,
                        f: "json"
                    };
                    var requestHandle = esriRequest({
                        url: featureLayer.url + '/query',
                        content: params,
                        handleAs: "json",
                    }, {
                            usePost: false
                        });

                    requestHandle.then(requestSucceeded, requestFailed);
                }

                function centerPoint(featureExtent, point) {
                    var xMid = (featureExtent.xmin + featureExtent.xmax) / 2;
                    var yMid = (featureExtent.ymin + featureExtent.ymax) / 2;
                    point.x = xMid;
                    point.y = yMid;
                    point.spatialReference = map.spatialReference;
                }

                function drawExtent() {

                }
            });
    </script>
</head>

<body class="claro">

    <div class="toolbar">
        <div id="anonymous">
            <span id="sign-in" class="action">Sign In</span>
        </div>
        <div id="personalized">Welcome
            <span id="userId"></span>
            <span id="sign-out" class="action"> Sign Out</span>
        </div>
    </div>

    <div class="content">
        <div id="map"></div>
    </div>
</body>

</html>