<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no">
    <title>Extent</title>
    <link rel="stylesheet" href="https://js.arcgis.com/3.18/dijit/themes/claro/claro.css">
    <link rel="stylesheet" href="https://js.arcgis.com/3.18/esri/css/esri.css">
    <style>
        html,
        body,
        #map {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
        }

        .toolbar {
            position: absolute;
            top: 0;
            width: 100%;
            height: 24px;
            background-color: #007ac2;
            color: #fff;
        }

        .content {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 24px;
        }

        .action {
            cursor: pointer;
            text-decoration: underline;
        }

        #anonymous {
            display: none;
            padding: 5px;
            text-align: center;
        }

        #personalized {
            display: none;
            padding: 5px;
            text-align: center;
        }

        #userId {
            font-weight: bold;
        }
    </style>

    <script>
        var dojoConfig = {
            parseOnLoad: true
        };
    </script>
    <script src="https://js.arcgis.com/3.18/"></script>
    <script>
        var map, graphicLayer;
        require([
            "esri/map",
            "esri/layers/FeatureLayer",
            "esri/geometry/Point",
            "esri/graphic",
            "esri/layers/GraphicsLayer",
            "esri/symbols/SimpleMarkerSymbol",
            "esri/SpatialReference",
            "esri/Color",
            "esri/InfoTemplate",
            "dojo/on",
            "dojo/_base/array",
            "esri/arcgis/Portal",
            "esri/arcgis/OAuthInfo",
            "esri/IdentityManager",
            "dojo/dom-style",
            "dojo/dom-attr",
            "dojo/dom",
            "esri/tasks/query",
            "esri/arcgis/utils",
            "esri/request",
            "dojo/domReady!"
        ], function (
            Map,
            FeatureLayer,
            Point,
            Graphic,
            GraphicsLayer,
            SimpleMarkerSymbol,
            SpatialReference,
            Color,
            InfoTemplate,
            on,
            array,
            arcgisPortal,
            OAuthInfo,
            esriId,
            domStyle,
            domAttr,
            dom,
            Query,
            arcgisUtils, 
            esriRequest
        ) {
                esri.config.defaults.io.corsEnabledServers.push("http://bankbeetle.esri.com");

                var info = new OAuthInfo({
                    appId: "r39INBsvcaokxCns",
                    popup: false,
                    portalUrl: "https://bankbeetle.esri.com/portal"
                });

                esriId.registerOAuthInfos([info]);
                esriId.checkSignInStatus(info.portalUrl + "/sharing").then(
                    function () {
                        new arcgisPortal.Portal(info.portalUrl).signIn().then(
                            function (portalUser) {
                                domAttr.set("userId", "innerHTML", portalUser.fullName);
                                domStyle.set("anonymous", "display", "none");
                                domStyle.set("personalized", "display", "block");
                                addLayers();
                            }
                        ).otherwise(
                            function (error) {
                                console.log("Error occurred while signing in: ", error);
                            }
                        );
                    }
                ).otherwise(
                    function () {
                        // Anonymous view
                        domStyle.set("anonymous", "display", "block");
                        domStyle.set("personalized", "display", "none");
                        console.log("otherwise");
                    }
                );

                on(dom.byId("sign-in"), "click", function () {
                    console.log("sign-in");
                    esriId.getCredential(info.portalUrl + "/sharing");
                });

                on(dom.byId("sign-out"), "click", function () {
                    esriId.destroyCredentials();
                    window.location.reload();
                });

                map = new Map("map", {
                    basemap: "gray",
                    center: [-46.807, 32.553],
                    zoom: 4
                });

                function addLayers() {
                    console.log("addLayers!");
                    var featureLayer = new FeatureLayer("https://bankbeetle.esri.com/arcgis/rest/services/Hosted/USA_Boundaries_2015/FeatureServer/1");
                    //queryFeatures(featureLayer);
                }

                function requestSucceeded(res) {
                    console.log(res);
                }

                function requestFailed(evt) {
                    console.log("failed", evt);
                }

                function queryFeatures(featureLayer) {


                    var params = {
                        where: "1=1",
                        outFields: ["*"],
                        returnGeometry: true,
                        f: "json"
                    };

                    var requestHandle = esriRequest({
                        url: featureLayer.url + '/query',
                        content: params,
                        handleAs: "json",
                    }, {
                            usePost: false
                        });

                    requestHandle.then(requestSucceeded, requestFailed);
                }

                function centerPoint(featureExtent, point) {
                    var xMid = (featureExtent.xmin + featureExtent.xmax) / 2;
                    var yMid = (featureExtent.ymin + featureExtent.ymax) / 2;
                    point.x = xMid;
                    point.y = yMid;
                    point.spatialReference = map.spatialReference;
                }
            });
    </script>
</head>

<body class="claro">

    <div class="toolbar">
        <div id="anonymous">
            <span id="sign-in" class="action">Sign In</span>
        </div>
        <div id="personalized">Welcome
            <span id="userId"></span>
            <span id="sign-out" class="action"> Sign Out</span>
        </div>
    </div>

    <div class="content">
        <div id="map"></div>
    </div>
</body>

</html>