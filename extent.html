<!-- <!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no">
    <title>Extent</title>
    <link rel="stylesheet" href="https://js.arcgis.com/3.24/dijit/themes/claro/claro.css">
    <link rel="stylesheet" href="https://js.arcgis.com/3.24/esri/css/esri.css">
    <style>
        html,
        body,
        #map {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
        }

        .toolbar {
            position: absolute;
            top: 0;
            width: 100%;
            height: 24px;
            background-color: #007ac2;
            color: #fff;
        }

        .content {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 24px;
        }

        .action {
            cursor: pointer;
            text-decoration: underline;
        }

        #anonymous {
            display: none;
            padding: 5px;
            text-align: center;
        }

        #personalized {
            display: none;
            padding: 5px;
            text-align: center;
        }

        #userId {
            font-weight: bold;
        }
    </style>

    <script>
        var dojoConfig = {
            parseOnLoad: true
        };
    </script>
    <script src="https://js.arcgis.com/3.24/"></script>
    <script>
        var map, graphicLayer, featureLayer, arcgisDomain, arcgisPortal, appId;
        require([
            "esri/map",
            "esri/layers/FeatureLayer",
            "esri/geometry/Point",
            "esri/graphic",
            "esri/layers/GraphicsLayer",
            "esri/symbols/SimpleMarkerSymbol",
            "esri/symbols/SimpleFillSymbol",
            "esri/symbols/SimpleLineSymbol",
            "esri/SpatialReference",
            "esri/Color",
            "esri/InfoTemplate",
            "dojo/on",
            "dojo/_base/array",
            "esri/arcgis/Portal",
            "esri/arcgis/OAuthInfo",
            "esri/IdentityManager",
            "dojo/dom-style",
            "dojo/dom-attr",
            "dojo/dom",
            "esri/tasks/query",
            "esri/arcgis/utils",
            "esri/request",
            "esri/geometry/Extent",
            "esri/SpatialReference",
            "dojo/domReady!"
        ], function (
            Map,
            FeatureLayer,
            Point,
            Graphic,
            GraphicsLayer,
            SimpleMarkerSymbol,
            SimpleFillSymbol,
            SimpleLineSymbol,
            SpatialReference,
            Color,
            InfoTemplate,
            on,
            array,
            arcgisPortal,
            OAuthInfo,
            esriId,
            domStyle,
            domAttr,
            dom,
            Query,
            arcgisUtils,
            esriRequest
        ) {
                useBankBeetle()
                esri.config.defaults.io.corsEnabledServers.push(arcgisDomain);
                var info = new OAuthInfo({ appId: appId, popup: false, portalUrl: arcgisPortal });
                esriId.registerOAuthInfos([info]);
                esriId.checkSignInStatus(info.portalUrl + "/sharing/rest").then(
                    function () {
                        new arcgisPortal.Portal(info.portalUrl).signIn().then(
                            function (portalUser) {
                                domAttr.set("userId", "innerHTML", portalUser.fullName);
                                domStyle.set("anonymous", "display", "none");
                                domStyle.set("personalized", "display", "block");
                                addGraphicsLayer();
                                addLayers();
                                //dataExtent();
                                featuresExtent();
                                calcMaxOffset();

                            }
                        );
                    }
                ).otherwise(
                    function () {
                        domStyle.set("anonymous", "display", "block");
                        domStyle.set("personalized", "display", "none");
                    }
                );

                on(dom.byId("sign-in"), "click", function () {
                    console.log("sign-in");
                    esriId.getCredential(info.portalUrl + "/sharing/rest");
                });

                on(dom.byId("sign-out"), "click", function () {
                    esriId.destroyCredentials();
                    window.location.reload();
                });

                map = new Map("map", { basemap: "gray", center: [-46.807, 32.553], zoom: 4 });

                function addLayers() {
                    featureLayer = new FeatureLayer(arcgisDomain + "/arcgis/rest/services/Hosted/USA_Boundaries_2015/FeatureServer/1");
                    featureLayer.on('load', queryFeatures());
                }

                function getFillSymbol() {
                    var r = Math.floor(Math.random() * 250);
                    var g = Math.floor(Math.random() * 100);
                    var b = Math.floor(Math.random() * 100);
                    return new SimpleFillSymbol(SimpleFillSymbol.STYLE_SOLID,
                        new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID,
                            new Color([r, g, b]), 1), new Color([r, g, b, 0.25])
                    );
                }

                function requestSucceeded(res) {
                    // for (var i = 0; i < res.features.length; i++) {
                    //     console.log(res.features[i]);
                    // }

                    //var extent = new Extent(JSON.stringify(res.extent));
                    var extent = new esri.geometry.Extent({
                        "xmin": res.extent.xmin, "ymin": res.extent.ymin, "xmax": res.extent.xmax, "ymax": res.extent.ymax,
                        "spatialReference": { "wkid": 4326 }
                    });
                    console.log("extent", extent);
                    console.log("normal", extent.normalize());
                    var sfs = getFillSymbol();
                    var graphic = new Graphic(extent, sfs);
                    graphicLayer.add(graphic);
                }

                function requestFailed(evt) {
                    console.log("failed", evt);
                }

                function queryFeature(oid) {
                    var params = {
                        objectIds: oid,
                        returnExtentOnly: true,
                        f: "json"
                    };
                    var requestHandle = esriRequest({
                        url: featureLayer.url + '/query',
                        content: params,
                        handleAs: "json",
                    }, {
                            usePost: false
                        });

                    requestHandle.then(requestSucceeded, requestFailed);

                }

                function addGraphicsLayer() {
                    graphicLayer = new GraphicsLayer();
                    map.addLayer(graphicLayer);
                }

                function dataExtent() {
                    var params = {
                        where: "1=1",
                        returnExtentOnly: true,
                        f: "json"
                    };
                    var requestHandle = esriRequest({
                        url: featureLayer.url + '/query',
                        content: params,
                        handleAs: "json",
                    }, {
                            usePost: false
                        });

                    requestHandle.then(requestSucceeded, requestFailed);
                }

                function featuresExtent() {
                    var params = {
                        objectIds: "1,2,3",
                        outFields: ["*"],
                        returnExtentOnly: true,
                        f: "json"
                    };
                    var requestHandle = esriRequest({
                        url: featureLayer.url + '/query',
                        content: params,
                        handleAs: "json",
                    }, {
                            usePost: false
                        });

                    requestHandle.then(requestSucceeded, requestFailed);
                }

                function calcMaxOffset() {
                    var mapContainer = dom.byId("map");
                    var maxAllowableOffset = Math.sqrt(map.extent.getWidth() / mapContainer.width * map.extent.getHeight() / mapContainer.height);
                    //snap maxAllowableOffset to powers of 2 thus accepting a range of 0.5 px to 2 px between adjacent vertices
                    //snapping is needed for better caching on all levels: JS memory cache, HTTP cache, server-side cache
                    maxAllowableOffset = Math.pow(2, Math.round(Math.log2(maxAllowableOffset)));
                    console.log(maxAllowableOffset)
                }

                function queryFeatures() {
                    var oids = [1, 2, 3];
                    for (var i = 0; i < oids.length; i++) {
                        queryFeature(oids[i]);
                    }
                    return;
                    var params = {
                        objectIds: "1,2,3",
                        outFields: ["*"],
                        returnGeometry: true,
                        f: "json"
                    };
                    var requestHandle = esriRequest({
                        url: featureLayer.url + '/query',
                        content: params,
                        handleAs: "json",
                    }, {
                            usePost: false
                        });

                    requestHandle.then(requestSucceeded, requestFailed);
                }

                function centerPoint(featureExtent, point) {
                    var xMid = (featureExtent.xmin + featureExtent.xmax) / 2;
                    var yMid = (featureExtent.ymin + featureExtent.ymax) / 2;
                    point.x = xMid;
                    point.y = yMid;
                    point.spatialReference = map.spatialReference;
                }

                function useCrystalBugger() {
                    arcgisDomain = "https://crystalbugger.esri.com";
                    arcgisPortal = arcgisDomain + '/arcgis';
                    appId = "vVlLOA5bg05fnt9d";
                }

                function useBankBeetle() {
                    arcgisDomain = "https://bankbeetle.esri.com";
                    arcgisPortal = arcgisDomain + '/portal';
                    appId = "r39INBsvcaokxCns";
                }

                function drawExtent() {

                }
            });
    </script>
</head>

<body class="claro">

    <div class="toolbar">
        <div id="anonymous">
            <span id="sign-in" class="action">Sign In</span>
        </div>
        <div id="personalized">Welcome
            <span id="userId"></span>
            <span id="sign-out" class="action"> Sign Out</span>
        </div>
    </div>

    <div class="content">
        <div id="map"></div>
    </div>
</body>

</html> -->
<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,user-scalable=no">
    <title>Extent</title>
    <link rel="stylesheet" href="https://js.arcgis.com/3.24/dijit/themes/claro/claro.css">
    <link rel="stylesheet" href="https://js.arcgis.com/3.24/esri/css/esri.css">
    <style>
        html,
        body,
        #map {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
        }

        .toolbar {
            position: absolute;
            top: 0;
            width: 100%;
            height: 24px;
            background-color: #007ac2;
            color: #fff;
        }

        .content {
            position: absolute;
            width: 100%;
            height: 100%;
            /*top: 24px;*/
        }

        .action {
            cursor: pointer;
            text-decoration: underline;
        }

        #anonymous {
            display: none;
            padding: 5px;
            text-align: center;
        }

        #personalized {
            display: none;
            padding: 5px;
            text-align: center;
        }

        #userId {
            font-weight: bold;
        }
    </style>

    <script>
        var dojoConfig = {
            parseOnLoad: true
        };
    </script>
    <script src="https://js.arcgis.com/3.24/"></script>
    <script>
        var map, graphicLayer, featureLayer, arcgisDomain, arcgisPortalUrl, appId, catalog, dataset;
        catalog = "/arcgis/rest/services";
        dataset = "/Hosted/USA_Boundaries_2015/FeatureServer/1";

        require([
            "esri/map",
            "esri/layers/FeatureLayer",
            "esri/geometry/Point",
            "esri/geometry/Polygon",
            "esri/graphic",
            "esri/layers/GraphicsLayer",
            "esri/symbols/SimpleMarkerSymbol",
            "esri/symbols/SimpleFillSymbol",
            "esri/symbols/SimpleLineSymbol",
            "esri/SpatialReference",
            "esri/Color",
            "esri/InfoTemplate",
            "dojo/on",
            "dojo/_base/array",
            "esri/arcgis/Portal",
            "esri/arcgis/OAuthInfo",
            "esri/IdentityManager",
            "dojo/dom-style",
            "dojo/dom-attr",
            "dojo/dom",
            "esri/tasks/query",
            "esri/arcgis/utils",
            "esri/request",
            "esri/geometry/Extent",
            "esri/SpatialReference",
            "esri/geometry/geometryEngine",
            "esri/geometry/projection",
            "dojo/domReady!"
        ], function (
            Map,
            FeatureLayer,
            Point,
            Polygon,
            Graphic,
            GraphicsLayer,
            SimpleMarkerSymbol,
            SimpleFillSymbol,
            SimpleLineSymbol,
            SpatialReference,
            Color,
            InfoTemplate,
            on,
            array,
            arcgisPortal,
            OAuthInfo,
            esriId,
            domStyle,
            domAttr,
            dom,
            Query,
            arcgisUtils,
            esriRequest,
            Extent,
            SpatialReference,
            geometryEngine,
            projection
        ) {
                useCrystalBugger();
                attachToPortal();

                function useBankBeetle() {
                    arcgisDomain = "https://bankbeetle.esri.com";
                    arcgisPortalUrl = arcgisDomain + '/portal';
                    appId = "r39INBsvcaokxCns";
                }

                function useCrystalBugger() {
                    arcgisDomain = "https://crystalbugger.esri.com";
                    arcgisPortalUrl = arcgisDomain + '/arcgis';
                    appId = "vVlLOA5bg05fnt9d";
                }

                function attachToPortal() {
                    esri.config.defaults.io.corsEnabledServers.push(arcgisDomain);
                    var info = new OAuthInfo({
                        appId: appId,
                        popup: false,
                        portalUrl: arcgisPortalUrl
                    });
                    esriId.registerOAuthInfos([info]);
                    esriId.checkSignInStatus(info.portalUrl + "/sharing").then(
                        function () {
                            new arcgisPortal.Portal(info.portalUrl).signIn().then(
                                function (portalUser) {
                                    // domAttr.set("userId", "innerHTML", portalUser.fullName);
                                    // domStyle.set("anonymous", "display", "none");
                                    // domStyle.set("personalized", "display", "block");
                                    createMap();
                                    //addGraphicsLayer();
                                    //addLayers();
                                    //calcMaxOffset();
                                }
                            );
                        }
                    );
                    esriId.getCredential(info.portalUrl + "/sharing");

                    // on(dom.byId("option"), "click", function () {
                    //     console.log("option");
                    // });
                }

                function createMap() {
                    map = new Map("map", {
                        basemap: "gray-vector",
                        zoom: 5
                    });
                    map.on('load', addData());
                }

                function addData() {
                    featureLayer = new FeatureLayer(arcgisDomain + catalog + dataset, {
                        mode: FeatureLayer.MODE_SNAPSHOT,
                        outFields: ["objectid"]
                    });

                    featureLayer.on('load', async function () {
                        extent = await calculateExtent();
                        var e = extent;
                        console.log("extent:", extent);
                    });
                }

                async function calculateExtent() {
                    var oids = await getOids();
                    return oids;
                }

                async function getOids() {
                    return new Promise(function (resolve, reject) {
                        var params = {
                            where: "1=1",
                            returnIdsOnly: true,
                            f: "json"
                        };
                        return esriRequest({
                            url: featureLayer.url + '/query',
                            content: params,
                            handleAs: "json",
                        }, { usePost: false }).then(function (resp) {
                            resolve(resp.objectIds);
                        }, function (err) {
                            reject(err);
                        });
                    });
                }

                function getFillSymbol() {
                    var r = Math.floor(Math.random() * 250);
                    var g = Math.floor(Math.random() * 100);
                    var b = Math.floor(Math.random() * 100);
                    return new SimpleFillSymbol(SimpleFillSymbol.STYLE_SOLID,
                        new SimpleLineSymbol(SimpleLineSymbol.STYLE_SOLID,
                            new Color([r, g, b]), 1), new Color([r, g, b, 0.25])
                    );
                }

                function calcMaxOffset() {
                    var mapContainer = dom.byId("map");
                    var maxAllowableOffset = Math.sqrt(map.extent.getWidth() / mapContainer.getBoundingClientRect().width * map.extent.getHeight() / mapContainer.getBoundingClientRect().height);
                    //snap maxAllowableOffset to powers of 2 thus accepting a range of 0.5 px to 2 px between adjacent vertices
                    //snapping is needed for better caching on all levels: JS memory cache, HTTP cache, server-side cache
                    //maxAllowableOffset = Math.pow(2, Math.round(Math.log2(maxAllowableOffset)));
                    console.log(maxAllowableOffset)
                }

                function requestSucceeded(res) {
                    // for (var i = 0; i < res.features.length; i++) {
                    //     console.log(res.features[i]);
                    // }

                    //var extent = new Extent(JSON.stringify(res.extent));
                    var extent = new esri.geometry.Extent({
                        "xmin": res.extent.xmin, "ymin": res.extent.ymin, "xmax": res.extent.xmax, "ymax": res.extent.ymax,
                        "spatialReference": { "wkid": 4326 }
                    });
                    var sfs = getFillSymbol();
                    var graphic = new Graphic(extent, sfs);
                    graphicLayer.add(graphic);
                }

                function requestFailed(evt) {
                    console.log("failed", evt);
                }

                function queryFeature(oid) {
                    var params = {
                        objectIds: oid,
                        returnExtentOnly: true,
                        f: "json"
                    };
                    var requestHandle = esriRequest({
                        url: featureLayer.url + '/query',
                        content: params,
                        handleAs: "json",
                    }, {
                            usePost: false
                        });

                    requestHandle.then(requestSucceeded, requestFailed);

                }

                function addGraphicsLayer() {
                    graphicLayer = new GraphicsLayer();
                    map.addLayer(graphicLayer);
                }

                function dataExtent() {
                    var params = {
                        where: "1=1",
                        outFields: ["*"],
                        returnExtentOnly: true,
                        f: "json"
                    };
                    var requestHandle = esriRequest({
                        url: featureLayer.url + '/query',
                        content: params,
                        handleAs: "json",
                    }, {
                            usePost: false
                        });

                    requestHandle.then(requestSucceeded, requestFailed);
                }

                function featuresExtent() {
                    var params = {
                        objectIds: "1,2,3",
                        outFields: ["*"],
                        returnExtentOnly: true,
                        f: "json"
                    };
                    var requestHandle = esriRequest({
                        url: featureLayer.url + '/query',
                        content: params,
                        handleAs: "json",
                    }, {
                            usePost: false
                        });

                    requestHandle.then(requestSucceeded, requestFailed);
                }

                function queryFeatures() {
                    // var oids = [1, 2, 3];
                    // for (var i = 0; i < oids.length; i++) {
                    //     queryFeature(oids[i]);
                    // }
                    // return;
                    var params = {
                        objectIds: "1,2,3",
                        outFields: ["*"],
                        returnGeometry: true,
                        maxAllowableOffset: 1,
                        f: "json"
                    };
                    var requestHandle = esriRequest({
                        url: featureLayer.url + '/query',
                        content: params,
                        handleAs: "json",
                    }, {
                            usePost: false
                        });

                    requestHandle.then(drawFeatures, requestFailed);
                }

                function drawFeatures(featureSet) {
                    var centerPts = [];
                    for (var i = 0; i < featureSet.features.length; i++) {
                        var feature = featureSet.features[i];
                        var sfs = getFillSymbol();
                        //feature.geometry.spatialReference = {"wkid":4326 };
                        var json = feature.geometry;
                        var poly = new Polygon(json);
                        centerPts.push(getCenterPoint(poly.getExtent(), new Point()));
                        var g = new Graphic(poly, sfs);
                        map.graphics.add(g);
                    }
                    var hull = geometryEngine.convexHull(centerPts, true);
                    webAssemblyProjection(hull[0], map.spatialReference).then(function (geom) {
                        var g = geom;
                        map.setExtent(geom.getExtent());
                    });
                }

                function webAssemblyProjection(geom, outSpat) {
                    if (!projection.isSupported()) {
                        console.log("Web Assembly not supported on this browser (<=IE11), do geom service");
                        //// Project w/ geometry service
                    }
                    return projection.load().then(function () {
                        return projection.project(geom, outSpat);
                    });
                }

                function getCenterPoint(geoExtent, point) {
                    var xMid = (geoExtent.xmin + geoExtent.xmax) / 2;
                    var yMid = (geoExtent.ymin + geoExtent.ymax) / 2;
                    point.x = xMid;
                    point.y = yMid;
                    point.spatialReference = geoExtent.spatialReference;
                    return point;
                }

                function drawExtent() {

                }
            });
    </script>
</head>

<body class="claro">

    <!-- <div class="toolbar">
        <div id="anonymous">
            <span id="sign-in" class="action">Sign In</span>
        </div>
        <div id="personalized">Welcome
            <span id="userId"></span>
            <span id="sign-out" class="action"> Sign Out</span>
        </div>
    </div> -->


    <div id="map"></div>

</body>

</html>